name: Build & publish Docker image

on:
  release:
    types: [published]
  push:
    branches:
      - '**'
  workflow_dispatch:
    inputs:
      latest:
        type: boolean
        description: "Whether or not to tag latest"
        required: true
        default: false

env:
  AWS_REGION: us-west-2
  ECR_REGISTRY: 612212029444.dkr.ecr.us-west-2.amazonaws.com

permissions:
  id-token: write # This is required for requesting the JWT
  contents: read

jobs:
  publish_to_docker_hub:
    runs-on: ubuntu-latest

    env:
      DOCKER_TAG: ${{ github.ref_name }}

    steps:
      - name: Dump GitHub context
        id: github_context_step
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"

      - name: Dump Input context
        id: input_context_step
        env:
          INPUT_CONTEXT: ${{ toJson(inputs) }}
        run: echo "$INPUT_CONTEXT"

      - name: Checkout
        uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          check-latest: true

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PAT }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v3
        with:
          images: temporal-s2s-proxy
          tags: |
            type=sha,format=short,event=branch
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.event_name == 'push' || github.event.inputs.latest }}

      - name: Build and push
        if: github.ref_name == 'main' || github.event_name == 'release'
        id: docker_build
        uses: docker/build-push-action@v3
        with:
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          file: Dockerfile
          context: .

  publish_to_cloud_registries:
    runs-on: ubuntu-latest

    env:
      DOCKER_TAG: ${{ github.sha }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          check-latest: true

      - name: Generate GitHub token
        id: generate-token
        uses: tibdex/github-app-token@b62528385c34dbc9f38e5f4225ac829252d1ea92
        with:
          app_id: ${{ secrets.TEMPORAL_CICD_APP_ID }}
          private_key: ${{ secrets.TEMPORAL_CICD_PRIVATE_KEY }}
          permissions: >-
            {"contents": "read"}

      - name: login to cloud registries
        uses: temporalio/private-actions/docker/cloud-docker-login@main

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: add test prefix for non-main branches
        if: github.ref_type == 'branch' && github.ref_name != 'main'
        run: |
          echo "DOCKER_TAG=test-${DOCKER_TAG}" | tee -a "$GITHUB_ENV"

      - name: Build and push image to repositories
        uses: temporalio/private-actions/docker/build-and-push-to-registries@main
        with:
          image_name: temporal-s2s-proxy
          tag: ${{ env.DOCKER_TAG }}

      - name: Tag existing images with release tags
        uses: temporalio/private-actions/docker/retag-image@main
        if: env.RELEASE_TAG != ''
        with:
          image_name: temporal-s2s-proxy
          source_tag: ${{ env.DOCKER_TAG }}
          tag: ${{ env.RELEASE_TAG }}