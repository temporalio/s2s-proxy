suite: test configmap
templates:
  - configmap.yaml
tests:
  - it: should override s2s-proxy config
    set:
      configOverride:
        clusterConnections:
          - remoteClusterHealthCheck:
              listenAddress: 0.0.0.0:1111
            local:
              tcpClient:
                address: "frontend-other:2222"
            remote:
              muxAddressInfo:
                address: "addr:3333"
    asserts:
      - isKind:
          of: ConfigMap
      - matchRegex:
          path: metadata.name
          pattern: RELEASE-NAME-s2s-proxy
      # Brittle regex matching. Not sure how better to check yaml inside of a string though.
      - matchRegex:
          path: data["config.yaml"]
          pattern: |-
            remoteClusterHealthCheck:
              \s*listenAddress: 0.0.0.0:1111
      - matchRegex:
          path: data["config.yaml"]
          pattern: |-
            tcpClient:
              \s*address: frontend-other:2222
      - matchRegex:
          path: data["config.yaml"]
          pattern: |-
            muxAddressInfo:
              \s*address: addr:3333
